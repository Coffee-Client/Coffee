/*
 * Copyright (c) 2022 Coffee Client, 0x150 and contributors.
 * Some rights reserved, refer to LICENSE file.
 */

package coffee.client.feature.module.impl.exploit;

import coffee.client.CoffeeMain;
import coffee.client.feature.config.BooleanSetting;
import coffee.client.feature.config.DoubleSetting;
import coffee.client.feature.module.Module;
import coffee.client.feature.module.ModuleType;
import coffee.client.helper.event.EventType;
import coffee.client.helper.event.Events;
import coffee.client.helper.event.events.PacketEvent;
import coffee.client.helper.util.Rotations;
import coffee.client.helper.util.Utils;
import net.minecraft.client.util.math.MatrixStack;
import net.minecraft.entity.Entity;
import net.minecraft.entity.EntityType;
import net.minecraft.entity.LivingEntity;
import net.minecraft.item.BowItem;
import net.minecraft.item.Items;
import net.minecraft.network.packet.c2s.play.ClientCommandC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerActionC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket;
import net.minecraft.util.math.Vec3d;

import java.util.Objects;

public class InstaBow extends Module {

    final DoubleSetting it = this.config.create(new DoubleSetting.Builder(40).precision(0)
        .name("Iterations")
        .description("How often to spoof velocity (more = bigger damage)")
        .min(5)
        .max(100)
        .get());
    final BooleanSetting autoFire = this.config.create(new BooleanSetting.Builder(false).name("Auto fire")
        .description("Automatically fire the bow when its held and an entity is on the same Y")
        .get());

    public InstaBow() {
        super("InstaBow", "Exploits the velocity handler on the server to give your arrow near infinite velocity", ModuleType.EXPLOIT);
        Events.registerEventHandler(EventType.PACKET_SEND, event -> {
            if (!this.isEnabled()) {
                return;
            }
            PacketEvent pe = (PacketEvent) event;
            if (pe.getPacket() instanceof PlayerActionC2SPacket packet && packet.getAction() == PlayerActionC2SPacket.Action.RELEASE_USE_ITEM) {
                Vec3d a = Objects.requireNonNull(CoffeeMain.client.player).getPos().subtract(0, 1e-10, 0);
                Vec3d b = CoffeeMain.client.player.getPos().add(0, 1e-10, 0);
                Objects.requireNonNull(CoffeeMain.client.getNetworkHandler())
                    .sendPacket(new ClientCommandC2SPacket(CoffeeMain.client.player, ClientCommandC2SPacket.Mode.START_SPRINTING));
                for (int i = 0; i < it.getValue(); i++) {
                    PlayerMoveC2SPacket p = new PlayerMoveC2SPacket.PositionAndOnGround(a.x, a.y, a.z, true);
                    PlayerMoveC2SPacket p1 = new PlayerMoveC2SPacket.PositionAndOnGround(b.x, b.y, b.z, false);
                    CoffeeMain.client.getNetworkHandler().sendPacket(p);
                    CoffeeMain.client.getNetworkHandler().sendPacket(p1);
                }
            }
        }, 0);
    }

    @Override
    public void tick() {
        if (!autoFire.getValue()) {
            return;
        }
        Vec3d ep = Objects.requireNonNull(CoffeeMain.client.player).getEyePos();
        Entity nearestApplicable = null;
        for (Entity entity : Objects.requireNonNull(CoffeeMain.client.world).getEntities()) {
            if (entity.getType() == EntityType.ENDERMAN) {
                continue;
            }
            if (!(entity instanceof LivingEntity ent) || !ent.isAttackable() || ent.isDead() || entity.equals(CoffeeMain.client.player)) {
                continue;
            }
            Vec3d origin = entity.getPos();
            float h = entity.getHeight();
            Vec3d upper = origin.add(0, h, 0);
            Vec3d center = entity.getPos().add(0, h / 2f, 0);
            if (Utils.Math.isABObstructed(ep, center, CoffeeMain.client.world, CoffeeMain.client.player)) {
                continue;
            }
            if (ep.y < upper.y && ep.y > origin.y) { // entity's on our Y
                if (nearestApplicable == null || nearestApplicable.distanceTo(CoffeeMain.client.player) > origin.distanceTo(CoffeeMain.client.player.getPos())) {
                    nearestApplicable = entity;
                }
            }
        }
        if (nearestApplicable == null) {
            return;
        }
        if (CoffeeMain.client.player.isUsingItem() && CoffeeMain.client.player.getMainHandStack().getItem() == Items.BOW) {
            BowItem be = (BowItem) CoffeeMain.client.player.getMainHandStack().getItem();
            int p = be.getMaxUseTime(null) - CoffeeMain.client.player.getItemUseTimeLeft();
            if (BowItem.getPullProgress(p) > 0.1) {
                Rotations.lookAtV3(nearestApplicable.getPos().add(0, nearestApplicable.getHeight() / 2f, 0));
                Objects.requireNonNull(CoffeeMain.client.getNetworkHandler())
                    .sendPacket(new PlayerMoveC2SPacket.LookAndOnGround(Rotations.getClientYaw(), Rotations.getClientPitch(), CoffeeMain.client.player.isOnGround()));
                Objects.requireNonNull(CoffeeMain.client.interactionManager).stopUsingItem(CoffeeMain.client.player);
            }
        }
    }

    @Override
    public void enable() {

    }

    @Override
    public void disable() {

    }

    @Override
    public String getContext() {
        return null;
    }

    @Override
    public void onWorldRender(MatrixStack matrices) {

    }

    @Override
    public void onHudRender() {

    }
}
